<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Actual Ad SDK Link -->
    <script src='//libtl.com/sdk.js' data-zone='10111740' data-sdk='show_10111740'></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Roller Mini App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }

        /* Custom CSS for the Die */
        .die-face {
            width: 80px;
            height: 80px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 8px;
            transform: scale(1);
            transition: transform 0.1s ease-in-out;
        }

        .die-face.rolling {
            /* Simple animation to show activity */
            animation: bounce 0.1s infinite alternate;
        }

        @keyframes bounce {
            from {
                transform: translateY(-2px);
            }

            to {
                transform: translateY(2px);
            }
        }

        .pip {
            background-color: #1e293b;
            /* Dark pip color */
            width: 10px;
            height: 10px;
            border-radius: 50%;
            place-self: center;
            opacity: 0;
            /* Initially hidden */
            transition: opacity 0.1s;
        }

        /* Utility classes for pip visibility (used by JS) */
        .pip-visible {
            opacity: 1;
        }

        /* Adjust die size for larger screens */
        @media (min-width: 640px) {
            .die-face {
                width: 120px;
                height: 120px;
                border-radius: 16px;
                padding: 12px;
            }

            .pip {
                width: 16px;
                height: 16px;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-8">
        <h1 class="text-3xl font-bold text-center text-gray-800">
            ðŸŽ² Twin Dice Roller ðŸŽ²
        </h1>

        <!-- Dice Display Area -->
        <div class="flex justify-center items-center space-x-6 md:space-x-10">
            <!-- Die 1 Container -->
            <div id="die1" class="die-face">
                <span class="pip pip-0"></span><span class="pip pip-1"></span><span class="pip pip-2"></span>
                <span class="pip pip-3"></span><span class="pip pip-4"></span><span class="pip pip-5"></span>
                <span class="pip pip-6"></span><span class="pip pip-7"></span><span class="pip pip-8"></span>
            </div>

            <!-- Die 2 Container -->
            <div id="die2" class="die-face">
                <span class="pip pip-0"></span><span class="pip pip-1"></span><span class="pip pip-2"></span>
                <span class="pip pip-3"></span><span class="pip pip-4"></span><span class="pip pip-5"></span>
                <span class="pip pip-6"></span><span class="pip pip-7"></span><span class="pip pip-8"></span>
            </div>
        </div>

        <!-- Total Display -->
        <div class="text-center">
            <p class="text-lg text-gray-600 mb-2">Current Total:</p>
            <p id="total-display" class="text-6xl font-extrabold text-blue-600 transition duration-300">
                0
            </p>
        </div>

        <!-- Roll Button -->
        <button id="roll-button"
            class="w-full py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold text-xl rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.01] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-50">
            Roll Dice
        </button>
        
        <p id="statusMessage" class="mt-4 text-sm text-gray-500 min-h-[1.25rem]">
            Ready to roll.
        </p>

    </div>

    <script>
        // --- Firebase Globals (Required for environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ---------------------------------------------------

        // Ad State and Configuration (Persistent for the session)
        let adSessionState = {
            adsShown: 0,
            lastAdTime: 0, 
            cappingExpiration: 0,
        };
        const AD_CONFIG = {
            frequency: 36,
            capping: 0.1, // 0.1 hours = 6 minutes
            interval: 10, // 30 seconds
            timeout: 0,   // Original timeout (used for subsequent ads)
            everyPage: false // Session persists across pages
        };
        const CAP_DURATION_MS = AD_CONFIG.capping * 3600 * 1000; // 6 minutes in milliseconds

        const AdController = window.Adsgram.init({ blockId: b2c70827a3c54151a0e59558d4af247a });

        

        // --- DOM Elements ---
        const die1Element = document.getElementById('die1');
        const die2Element = document.getElementById('die2');
        const rollButton = document.getElementById('roll-button');
        const totalDisplay = document.getElementById('total-display');
        const statusMessage = document.getElementById('statusMessage');

        // --- Dice Rendering Logic ---
        const PIP_MAP = {
            1: [4],
            2: [0, 8],
            3: [0, 4, 8],
            4: [0, 2, 6, 8],
            5: [0, 2, 4, 6, 8],
            6: [0, 2, 3, 5, 6, 8]
        };

        function renderDie(dieElement, value) {
            const pips = dieElement.querySelectorAll('.pip');
            const visiblePips = PIP_MAP[value] || [];
            pips.forEach(pip => pip.classList.remove('pip-visible'));
            visiblePips.forEach(index => {
                if (pips[index]) {
                    pips[index].classList.add('pip-visible');
                }
            });
        }

        function rollSingleDie() {
            return Math.floor(Math.random() * 6) + 1;
        }

        // --- Core Game Action ---
        function executeDiceRoll() {
            rollButton.disabled = true;
            rollButton.textContent = 'Rolling...';
            die1Element.classList.add('rolling');
            die2Element.classList.add('rolling');
            statusMessage.textContent = 'Executing dice roll.';
            
            const rollDuration = 500;

            let rollInterval = setInterval(() => {
                renderDie(die1Element, rollSingleDie());
                renderDie(die2Element, rollSingleDie());
                totalDisplay.textContent = '?';
            }, 50);

            setTimeout(() => {
                clearInterval(rollInterval);

                const value1 = rollSingleDie();
                const value2 = rollSingleDie();
                const total = value1 + value2;

                renderDie(die1Element, value1);
                renderDie(die2Element, value2);
                totalDisplay.textContent = total;

                die1Element.classList.remove('rolling');
                die2Element.classList.remove('rolling');
                rollButton.disabled = false;
                rollButton.textContent = 'Roll Dice';
                statusMessage.textContent = `Rolled: ${total}. Ready for next roll.`;
                console.log(`[DICE ROLL] Game action executed. Total: ${total}.`);
            }, rollDuration);
        }

        // --- Ad Control Logic (Modified for instant first ad) ---
        
        function checkAndRunAdOrRoll() {
            const now = Date.now();
            statusMessage.textContent = "Checking ad rules...";
            console.log("--- Ad Rule Check Triggered ---");

            // 1. Capping Reset Check (6 minutes)
            if (now > adSessionState.cappingExpiration) {
                adSessionState.adsShown = 0;
                adSessionState.cappingExpiration = now + CAP_DURATION_MS;
                console.log(`Capping reset. New period ends: ${new Date(adSessionState.cappingExpiration).toLocaleTimeString()}.`);
            }

            // 2. Frequency Limit Check (Max 2 ads)
            if (adSessionState.adsShown >= AD_CONFIG.frequency) {
                console.warn(`FAIL: Frequency limit reached (${adSessionState.adsShown} of ${AD_CONFIG.frequency}). Executing game action.`);
                statusMessage.textContent = "Ad blocked by frequency cap. Rolling dice...";
                executeDiceRoll();
                return;
            }

            // 3. Interval Check (30 seconds)
            const intervalMs = AD_CONFIG.interval * 1000;
            if (adSessionState.lastAdTime > 0) {
                const timeSinceLastAd = now - adSessionState.lastAdTime;
                if (timeSinceLastAd < intervalMs) {
                    const remainingDelay = Math.ceil((intervalMs - timeSinceLastAd) / 1000);
                    console.warn(`FAIL: Interval not met. Wait ${remainingDelay}s more. Executing game action.`);
                    statusMessage.textContent = `Ad blocked by interval (${remainingDelay}s left). Rolling dice...`;
                    executeDiceRoll();
                    return;
                }
            }
            
            // --- SUCCESS: All custom checks passed. Call the External Ad Function ---
            if (typeof show_10111740 === 'function') {
                
                let adConfigToPass = { ...AD_CONFIG };

                // Overwrite the timeout to 0 ONLY for the first ad
                if (adSessionState.adsShown === 0) {
                    adConfigToPass.timeout = 0;
                    console.log("First ad request: Temporarily setting 'timeout' to 0 for instant display.");
                }

                console.log(`PASS: All checks passed. Calling external ad SDK with timeout: ${adConfigToPass.timeout}.`);
                
                // Call the actual SDK function
                show_10111740({
                    type: 'inApp',
                    inAppSettings: adConfigToPass 
                });
                
                // Optimistically update state
                adSessionState.adsShown++;
                adSessionState.lastAdTime = now;
                statusMessage.textContent = "Ad triggered immediately.";
                console.log(`SUCCESS: Ad triggered. Total: ${adSessionState.adsShown}.`);
            } else {
                console.error("WARNING: External ad SDK function 'show_10111740' is not available. Running game action.");
                executeDiceRoll();
            }
        }

        // --- Initialization and Event Listener ---

        // 1. Attach event listener to the button
        rollButton.addEventListener('click', checkAndRunAdOrRoll);

        // 2. Initialize the dice to a starting state
        renderDie(die1Element, 1);
        renderDie(die2Element, 1);
        totalDisplay.textContent = '2';

        window.onload = () => {
             console.log("Ad Logic Initialized. First click should trigger the ad instantly (timeout=0). Subsequent clicks are controlled by the 30s interval.");
        }
    </script>
</body>

</html>

